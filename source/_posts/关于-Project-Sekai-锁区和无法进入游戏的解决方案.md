---
title: 关于 Project Sekai 锁区和无法进入游戏的解决方案
date: 2023-04-30 00:00:00
tags:
---

## 前言

`Project Sekai: Colorful Stage! feat. Hatsune Miku`（以下简称 `PJSK`）是世嘉开发的一款音乐游戏，在进入游戏的过程中会检测玩家 IP 是否在允许列表中，如果不在则会禁止玩家登录。无法登录游戏的常见情况有如下几种：

1. 提示 `会话已过期，返回标题界面`（如图），这种情况一般是 IP 不在允许登录的范围内，即 **被锁区**

   ![](1682833256196.webp)

2. 依次出现两个弹窗，第一个提示 `发生通信错误`，第二个提示 `回到标题界面`，一般是网络不稳定造成的，不能确定是否被锁区

   ![](1682833260822.webp)

   ![](1682833264335.webp)

3. 进入游戏登录界面并点击后又返回登录界面，并且无任何弹窗提示，这种和第二种情况类似，一般为网络原因

## 锁区原理探究

对于以上的第二和第三种情况，请检查网络问题并重试，这里重点讨论第一种情况（被锁区）的解决方案。

在进入游戏的过程中主要向以下几个域名发起连接：

```bash
cdp.cloud.unity3d.com
config.uca.cloud.unity3d.com
production-xxxxxxxx-assetbundle.sekai.colorfulpalette.org
production-xxxxxxxx-assetbundle-info.sekai.colorfulpalette.org
issue.sekai.colorfulpalette.org
game-version.sekai.colorfulpalette.org
```

以下域名是 unity 用于收集分析数据的（见 [https://stackoverflow.com/questions/46045805/why-my-game-is-trying-to-connect-to-external-server](https://stackoverflow.com/questions/46045805/why-my-game-is-trying-to-connect-to-external-server)），这两个域名在进入游戏 Rizline 时也会出现

```bash
cdp.cloud.unity3d.com
config.uca.cloud.unity3d.com
```

以下域名为游戏中分发静态资源（例如音乐、谱面文件和图片等）的域名，其中 `xxxxxxxx` 为八位字母和数字组合

```bash
production-xxxxxxxx-assetbundle.sekai.colorfulpalette.org
production-xxxxxxxx-assetbundle-info.sekai.colorfulpalette.org
```

以下域名用于 **游戏结束** 上传成绩时和服务器通信：

```bash
production-web.sekai.colorfulpalette.org
production-game-api.sekai.colorfulpalette.org
```

以下域名用于在 **登录游戏** 时验证玩家 IP 是否在允许范围内（是否解锁），如果不是则会出现无法进入游戏的情况

```bash
issue.sekai.colorfulpalette.org
game-version.sekai.colorfulpalette.org
```

解决锁区问题的核心就是 **以上两个域名** 需要通过官方允许的 IP 向服务器发起连接。

## 解决方案

以 Clash 为例，首先创建一个类型为 `select` 的策略组，将可用节点添加到策略组中：

```yaml
proxy-groups:
  - name: プロセカ
    type: select
    use: [机场1, 机场2, ...]
```

接下来需要将域名 `issue.sekai.colorfulpalette.org` 和 `game-version.sekai.colorfulpalette.org` 分流到 `プロセカ` 策略组，对应 Clash 分流规则如下：

```yaml
rules:
  - DOMAIN,issue.sekai.colorfulpalette.org,プロセカ
  - DOMAIN,game-version.sekai.colorfulpalette.org,プロセカ
```

最后，我们还需要逐一测试 `プロセカ` 策略组中节点是否解锁，具体方法如下：

1. 在选择节点之后直接登录游戏，检查是否能正常进入游戏
2. 使用 curl 或其他 HTTP 请求工具向 `game-version.sekai.colorfulpalette.org` 域名发送请求，观察返回结果

   - 解锁失败情况下的返回结果如下，此时登录游戏会提示 `会话已过期，返回标题界面`

     ```html
     <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
     <html>
       <head>
         <meta
           http-equiv="Content-Type"
           content="text/html; charset=iso-8859-1"
         />
         <title>ERROR: The request could not be satisfied</title>
       </head>
       <body>
         <h1>403 ERROR</h1>
         <h2>The request could not be satisfied.</h2>
         <hr noshade size="1px" />
         Request blocked. We can't connect to the server for this app or website
         at this time. There might be too much traffic or a configuration error.
         Try again later, or contact the app or website owner.
         <br clear="all" />
         If you provide content to customers through CloudFront, you can find
         steps to troubleshoot and help prevent this error by reviewing the
         CloudFront documentation.
         <br clear="all" />
         <hr noshade size="1px" />
         <pre>
     Generated by cloudfront (CloudFront)
     Request ID: qcVUtioo_xAhsMx7Q-AfWC5c-X72Abmr-fM8mv2clNXfPoJ5g3kr3g==
     </pre
         >
         <address></address>
       </body>
     </html>
     ```

   - 解锁成功时返回的结果如下，此时能正常进入游戏

     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <Error><Code>AccessDenied</Code><Message>Access Denied</Message><RequestId>EJ865XKG7EW1Z5W6</RequestId><HostId>NhL8N6Fxgtpk4slR/6b+DSFiYhSscjPtujrr7ZKudMEgrJPn9Rd2qlBTvx02KIV3twIrtpQZkwg=</HostId></Error>
     ```

## 节点解锁一键测试脚本

由于 Clash 提供的 RESTful API，可以用于获取节点信息、修改策略组选中的节点。因此，测试节点是否解锁的过程可以自动化，同时避免了每次进入游戏之前都要手动选择节点的麻烦。

我为 Clash 编写的 Python 脚本如下，每次进入游戏之前运行一次即可自动已解锁的节点（注意修改相应信息）。

```python
import requests


# 测试当前选中节点是否解锁
def test_unlock() -> bool:
    try:
        r = requests.get(
            "https://game-version.sekai.colorfulpalette.org",
            headers={
                "User-Agent": "UnityPlayer/2019.4.3f1"
                "(UnityWebRequest/1.0, libcurl/7.52.0-DEV)"
            },
        )
    except:
        print("❌解锁失败")
        return False
    else:
        res = r.text.strip()
        if "<!DOCTYPE" in res and "Request blocked." in res:
            print("❌解锁失败")
            return False
        elif "<?xml" in res and "AccessDenied" in res:
            print("✔解锁成功")
            return True
        else:
            print("❓未知状态")
            print(res)
            return False


# 假设使用的策略组名称为 `プロセカ`
url = "http://192.168.1.11:9090/proxies/プロセカ"
# 获取 `プロセカ` 策略组中的所有节点名称
r = requests.get(url)
all_proxies = r.json().get("all")
# 对每个节点分别测试, 找到第一个解锁成功的节点马上退出
for proxy in all_proxies:
    print(f"正在测试 {proxy}: ", end="\t\t")
    r = requests.put(url, json={"name": proxy})
    ok = test_unlock()
    if ok:
        print(f"使用节点 {proxy} 解锁成功！")
        break
else:
    print("全部节点解锁失败！")
```
